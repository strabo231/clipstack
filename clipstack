#!/bin/bash

# ClipStack - Clipboard History Manager
# Version: 1.0.0

VERSION="1.0.0"
SCRIPT_NAME="clipstack"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_header() { echo -e "${CYAN}${BOLD}${1}${NC}"; }

# Data directory
CLIPSTACK_DIR="$HOME/.clipstack"
HISTORY_FILE="$CLIPSTACK_DIR/history"
PINNED_FILE="$CLIPSTACK_DIR/pinned"
CONFIG_FILE="$CLIPSTACK_DIR/config"

mkdir -p "$CLIPSTACK_DIR"
touch "$HISTORY_FILE" "$PINNED_FILE" "$CONFIG_FILE"

# Configuration
MAX_HISTORY=1000
MAX_ITEM_LENGTH=500

show_usage() {
    cat << EOF
${BLUE}${BOLD}ClipStack${NC} - Clipboard History Manager v${VERSION}

${YELLOW}Usage:${NC}
    $SCRIPT_NAME [command] [options]

${YELLOW}Commands:${NC}
    (no command)             Show clipboard history
    list                     List all items
    search <query>           Search clipboard history
    get <n>                  Get item by number
    copy <n>                 Copy item to clipboard
    pin <n>                  Pin item (keep forever)
    unpin <n>                Unpin item
    pinned                   Show pinned items
    delete <n>               Delete item
    clear                    Clear all history
    stats                    Show usage statistics
    watch                    Monitor clipboard (daemon mode)

${YELLOW}Options:${NC}
    -h, --help              Show this help
    -v, --version           Show version
    -n, --no-color          Disable colors

${YELLOW}Examples:${NC}
    $SCRIPT_NAME
        → Show clipboard history

    $SCRIPT_NAME search "api key"
        → Find items containing "api key"

    $SCRIPT_NAME copy 5
        → Copy item #5 to clipboard

    $SCRIPT_NAME pin 3
        → Pin item #3 permanently

    $SCRIPT_NAME watch
        → Start monitoring clipboard

${YELLOW}Quick Tips:${NC}
    • Items are numbered from newest (1) to oldest
    • Pinned items never expire
    • Search is case-insensitive
    • History persists across reboots

EOF
}

show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

# Get current clipboard content
get_clipboard() {
    if command -v xclip &> /dev/null; then
        xclip -selection clipboard -o 2>/dev/null
    elif command -v xsel &> /dev/null; then
        xsel --clipboard --output 2>/dev/null
    elif command -v pbpaste &> /dev/null; then
        pbpaste 2>/dev/null
    else
        print_error "No clipboard tool found (xclip, xsel, or pbpaste required)"
        return 1
    fi
}

# Set clipboard content
set_clipboard() {
    local content="$1"
    
    if command -v xclip &> /dev/null; then
        echo -n "$content" | xclip -selection clipboard
    elif command -v xsel &> /dev/null; then
        echo -n "$content" | xsel --clipboard --input
    elif command -v pbcopy &> /dev/null; then
        echo -n "$content" | pbcopy
    else
        print_error "No clipboard tool found (xclip, xsel, or pbcopy required)"
        return 1
    fi
}

# Add to history
add_to_history() {
    local content="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # Skip if empty
    [ -z "$content" ] && return
    
    # Skip if duplicate of last item
    local last=$(head -1 "$HISTORY_FILE" 2>/dev/null | cut -d'|' -f3-)
    [ "$content" = "$last" ] && return
    
    # Add to history
    echo "${timestamp}|${#content}|${content}" > "$HISTORY_FILE.tmp"
    cat "$HISTORY_FILE" >> "$HISTORY_FILE.tmp"
    
    # Trim to max history
    head -n "$MAX_HISTORY" "$HISTORY_FILE.tmp" > "$HISTORY_FILE"
    rm "$HISTORY_FILE.tmp"
}

# Format item preview
format_preview() {
    local content="$1"
    local max_length="${2:-80}"
    
    # Replace newlines with ⏎
    content=$(echo "$content" | tr '\n' '⏎')
    
    # Truncate if too long
    if [ ${#content} -gt $max_length ]; then
        echo "${content:0:$max_length}..."
    else
        echo "$content"
    fi
}

# Detect content type
detect_type() {
    local content="$1"
    
    if echo "$content" | grep -qE '^https?://'; then
        echo "URL"
    elif echo "$content" | grep -qE '^[0-9]+$'; then
        echo "Number"
    elif echo "$content" | grep -qE '^[a-f0-9]{32,}$'; then
        echo "Hash/Token"
    elif echo "$content" | grep -qE '(function|class|def|var|const|import)'; then
        echo "Code"
    elif echo "$content" | grep -qE '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'; then
        echo "Email"
    elif [ ${#content} -lt 20 ]; then
        echo "Short"
    else
        echo "Text"
    fi
}

# Show history
show_history() {
    if [ ! -s "$HISTORY_FILE" ]; then
        print_info "Clipboard history is empty"
        echo ""
        print_info "Copy something and it will appear here"
        print_info "Or run: $SCRIPT_NAME watch (to start monitoring)"
        return
    fi
    
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                   CLIPBOARD HISTORY"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    local count=0
    while IFS='|' read -r timestamp size content; do
        ((count++))
        
        local type=$(detect_type "$content")
        local preview=$(format_preview "$content" 70)
        
        echo -e "${CYAN}[$count]${NC} ${BOLD}$type${NC} ($size chars) - $timestamp"
        echo "  $preview"
        echo ""
        
        [ $count -ge 20 ] && break
    done < "$HISTORY_FILE"
    
    local total=$(wc -l < "$HISTORY_FILE")
    [ $total -gt 20 ] && print_info "Showing 20 of $total items"
    
    echo ""
    print_header "═══════════════════════════════════════════════════════════════"
    print_info "Commands: copy <n> | search <query> | pin <n> | clear"
    echo ""
}

# Search history
search_history() {
    local query="$1"
    
    if [ -z "$query" ]; then
        print_error "Please provide a search query"
        return 1
    fi
    
    print_header "Search results for: \"$query\""
    echo ""
    
    local count=0
    local found=0
    
    while IFS='|' read -r timestamp size content; do
        ((count++))
        
        if echo "$content" | grep -qi "$query"; then
            ((found++))
            local type=$(detect_type "$content")
            local preview=$(format_preview "$content" 70)
            
            echo -e "${CYAN}[$count]${NC} ${BOLD}$type${NC} - $timestamp"
            echo "  $preview"
            echo ""
        fi
    done < "$HISTORY_FILE"
    
    if [ $found -eq 0 ]; then
        print_warning "No results found"
    else
        print_success "Found $found items"
    fi
}

# Get specific item
get_item() {
    local num="$1"
    
    if [ -z "$num" ]; then
        print_error "Please specify item number"
        return 1
    fi
    
    local content=$(sed -n "${num}p" "$HISTORY_FILE" | cut -d'|' -f3-)
    
    if [ -z "$content" ]; then
        print_error "Item $num not found"
        return 1
    fi
    
    echo "$content"
}

# Copy item to clipboard
copy_item() {
    local num="$1"
    
    local content=$(get_item "$num")
    
    if [ $? -eq 0 ]; then
        set_clipboard "$content"
        print_success "Copied item $num to clipboard"
    fi
}

# Pin item
pin_item() {
    local num="$1"
    
    if [ -z "$num" ]; then
        print_error "Please specify item number"
        return 1
    fi
    
    local item=$(sed -n "${num}p" "$HISTORY_FILE")
    
    if [ -z "$item" ]; then
        print_error "Item $num not found"
        return 1
    fi
    
    # Check if already pinned
    local content=$(echo "$item" | cut -d'|' -f3-)
    if grep -qF "$content" "$PINNED_FILE" 2>/dev/null; then
        print_warning "Item already pinned"
        return 0
    fi
    
    echo "$item" >> "$PINNED_FILE"
    print_success "Pinned item $num"
}

# Unpin item
unpin_item() {
    local num="$1"
    
    if [ -z "$num" ]; then
        print_error "Please specify item number"
        return 1
    fi
    
    if [ ! -s "$PINNED_FILE" ]; then
        print_warning "No pinned items"
        return 0
    fi
    
    sed -i "${num}d" "$PINNED_FILE" 2>/dev/null
    print_success "Unpinned item $num"
}

# Show pinned items
show_pinned() {
    if [ ! -s "$PINNED_FILE" ]; then
        print_info "No pinned items"
        return
    fi
    
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                    PINNED ITEMS"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    local count=0
    while IFS='|' read -r timestamp size content; do
        ((count++))
        
        local type=$(detect_type "$content")
        local preview=$(format_preview "$content" 70)
        
        echo -e "${MAGENTA}[P$count]${NC} ${BOLD}$type${NC} - Pinned on $timestamp"
        echo "  $preview"
        echo ""
    done < "$PINNED_FILE"
    
    echo ""
}

# Delete item
delete_item() {
    local num="$1"
    
    if [ -z "$num" ]; then
        print_error "Please specify item number"
        return 1
    fi
    
    sed -i "${num}d" "$HISTORY_FILE" 2>/dev/null
    print_success "Deleted item $num"
}

# Clear history
clear_history() {
    read -p "Clear all clipboard history? (y/N) " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        > "$HISTORY_FILE"
        print_success "History cleared"
    else
        print_info "Cancelled"
    fi
}

# Show statistics
show_stats() {
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                   CLIPBOARD STATISTICS"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    local total=$(wc -l < "$HISTORY_FILE")
    local pinned=$(wc -l < "$PINNED_FILE")
    
    echo "Total items: $total"
    echo "Pinned items: $pinned"
    echo ""
    
    # Type breakdown
    echo "By type:"
    local urls=0
    local code=0
    local text=0
    
    while IFS='|' read -r timestamp size content; do
        local type=$(detect_type "$content")
        case "$type" in
            URL) ((urls++)) ;;
            Code) ((code++)) ;;
            *) ((text++)) ;;
        esac
    done < "$HISTORY_FILE"
    
    echo "  URLs: $urls"
    echo "  Code: $code"
    echo "  Text: $text"
    echo ""
}

# Watch clipboard (daemon mode)
watch_clipboard() {
    print_info "Monitoring clipboard... (Ctrl+C to stop)"
    echo ""
    
    local last=""
    
    while true; do
        local current=$(get_clipboard 2>/dev/null)
        
        if [ -n "$current" ] && [ "$current" != "$last" ]; then
            add_to_history "$current"
            
            local type=$(detect_type "$current")
            local preview=$(format_preview "$current" 50)
            
            print_success "Captured: $type"
            echo "  $preview"
            
            last="$current"
        fi
        
        sleep 1
    done
}

# Main command handling
if [ $# -eq 0 ]; then
    show_history
    exit 0
fi

COMMAND="$1"
shift

case "$COMMAND" in
    list|ls)
        show_history
        ;;
    search|find)
        search_history "$@"
        ;;
    get)
        get_item "$@"
        ;;
    copy|paste)
        copy_item "$@"
        ;;
    pin)
        pin_item "$@"
        ;;
    unpin)
        unpin_item "$@"
        ;;
    pinned|pins)
        show_pinned
        ;;
    delete|del|rm)
        delete_item "$@"
        ;;
    clear)
        clear_history
        ;;
    stats)
        show_stats
        ;;
    watch|monitor|daemon)
        watch_clipboard
        ;;
    -h|--help)
        show_usage
        ;;
    -v|--version)
        show_version
        ;;
    *)
        print_error "Unknown command: $COMMAND"
        echo "Use -h or --help for usage information"
        exit 1
        ;;
esac
